<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SAP Content Server Installer UI</title>
    <style>
      :root {
        color-scheme: light;
        font-family: Inter, Segoe UI, Roboto, Arial, sans-serif;
      }
      body {
        margin: 0;
        background: #f5f7fb;
        color: #162030;
      }
      .wrap {
        max-width: 920px;
        margin: 0 auto;
        padding: 24px;
      }
      .card {
        background: #fff;
        border: 1px solid #dfe4ef;
        border-radius: 12px;
        padding: 18px;
        margin-bottom: 16px;
      }
      h1 {
        font-size: 24px;
        margin: 0 0 8px;
      }
      p {
        margin: 0 0 12px;
      }
      .grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }
      .full {
        grid-column: 1 / -1;
      }
      label {
        display: block;
        font-size: 13px;
        margin-bottom: 6px;
        color: #33415c;
      }
      input[type="text"],
      input[type="password"] {
        width: 100%;
        box-sizing: border-box;
        border: 1px solid #c9d2e6;
        border-radius: 8px;
        padding: 10px;
        font-size: 14px;
      }
      .check {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      button {
        border: 0;
        background: #2563eb;
        color: #fff;
        border-radius: 8px;
        padding: 10px 14px;
        font-size: 14px;
        cursor: pointer;
      }
      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .muted {
        color: #5e6d8a;
        font-size: 13px;
      }
      pre {
        background: #0f172a;
        color: #e2e8f0;
        border-radius: 8px;
        padding: 12px;
        overflow: auto;
        min-height: 180px;
        white-space: pre-wrap;
      }
      .status {
        margin-bottom: 10px;
        font-weight: 600;
      }
      @media (max-width: 780px) {
        .grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="card">
        <h1>Installer & Configuration Wizard</h1>
        <p class="muted">Runs the local setup installer with your configuration. This tool can install dependencies, configure Firebase/GCP, and optionally deploy.</p>
      </div>

      <div class="card">
        <div class="grid">
          <div>
            <label for="mode">Mode</label>
            <input id="mode" type="text" value="admin" placeholder="admin or end-user" />
          </div>
          <div>
            <label for="configFile">Config file path (optional)</label>
            <input id="configFile" type="text" placeholder="installer/end-user-config.json" />
          </div>

          <div class="full">
            <label for="baseUrl">Base URL (end-user mode)</label>
            <input id="baseUrl" type="text" placeholder="https://us-central1-<project>.cloudfunctions.net/api" />
          </div>

          <div>
            <label for="project">Firebase project ID</label>
            <input id="project" type="text" placeholder="sap-content-server-ad957" />
          </div>
          <div>
            <label for="region">Functions region</label>
            <input id="region" type="text" value="us-central1" />
          </div>

          <div class="check">
            <input id="installDeps" type="checkbox" checked />
            <label for="installDeps">Install dependencies first (npm install)</label>
          </div>
          <div class="check">
            <input id="deploy" type="checkbox" checked />
            <label for="deploy">Deploy functions</label>
          </div>

          <div class="check">
            <input id="replicateToDrive" type="checkbox" checked />
            <label for="replicateToDrive">Enable Drive replication</label>
          </div>
          <div class="check">
            <input id="replicateStrict" type="checkbox" />
            <label for="replicateStrict">Strict replication</label>
          </div>

          <div class="full">
            <label for="driveFolderId">Google Drive folder ID</label>
            <input id="driveFolderId" type="text" placeholder="Drive root folder id" />
          </div>

          <div class="check full">
            <input id="useOAuth" type="checkbox" />
            <label for="useOAuth">Use OAuth Drive credentials</label>
          </div>

          <div>
            <label for="driveClientId">Drive client ID</label>
            <input id="driveClientId" type="text" />
          </div>
          <div>
            <label for="driveClientSecret">Drive client secret</label>
            <input id="driveClientSecret" type="password" />
          </div>
          <div class="full">
            <label for="driveRefreshToken">Drive refresh token</label>
            <input id="driveRefreshToken" type="password" />
          </div>

          <div class="check">
            <input id="dryRun" type="checkbox" />
            <label for="dryRun">Dry-run (no cloud changes)</label>
          </div>
        </div>

        <div style="margin-top: 14px">
          <button id="runBtn">Run installer</button>
        </div>
      </div>

      <div class="card">
        <div class="status" id="status">Status: idle</div>
        <pre id="output"></pre>
      </div>
    </div>

    <script>
      const runBtn = document.getElementById("runBtn");
      const statusEl = document.getElementById("status");
      const outputEl = document.getElementById("output");

      const getValue = (id) => document.getElementById(id).value;
      const getChecked = (id) => document.getElementById(id).checked;

      function setStatus(text) {
        statusEl.textContent = `Status: ${text}`;
      }

      function appendOutput(text) {
        outputEl.textContent = text;
      }

      runBtn.addEventListener("click", async () => {
        const payload = {
          mode: getValue("mode"),
          configFile: getValue("configFile"),
          baseUrl: getValue("baseUrl"),
          project: getValue("project"),
          region: getValue("region"),
          installDeps: getChecked("installDeps"),
          deploy: getChecked("deploy"),
          replicateToDrive: getChecked("replicateToDrive"),
          replicateStrict: getChecked("replicateStrict"),
          driveFolderId: getValue("driveFolderId"),
          useOAuth: getChecked("useOAuth"),
          driveClientId: getValue("driveClientId"),
          driveClientSecret: getValue("driveClientSecret"),
          driveRefreshToken: getValue("driveRefreshToken"),
          dryRun: getChecked("dryRun")
        };

        runBtn.disabled = true;
        setStatus("running");
        appendOutput("Running installer...\n");

        try {
          const res = await fetch("/api/run", {
            method: "POST",
            headers: { "content-type": "application/json" },
            body: JSON.stringify(payload)
          });

          const data = await res.json();
          const text = [
            `ok: ${data.ok}`,
            `exitCode: ${data.exitCode}`,
            "",
            "--- STDOUT ---",
            data.stdout || "",
            "",
            "--- STDERR ---",
            data.stderr || ""
          ].join("\n");

          appendOutput(text);
          setStatus(data.ok ? "completed" : "failed");
        } catch (error) {
          appendOutput(String(error));
          setStatus("failed");
        } finally {
          runBtn.disabled = false;
        }
      });
    </script>
  </body>
</html>
